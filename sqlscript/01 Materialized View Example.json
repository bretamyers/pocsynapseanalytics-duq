{
	"name": "01 Materialized View Example",
	"properties": {
		"folder": {
			"name": "Dedicated SQL Pool Features"
		},
		"content": {
			"query": "/* Use Case: \n    Using Materialized Views in Synapse Dedicated SQL Pools\n    to improve performance.\n*/\n\n-- Run the Original Query\nWITH year_total AS (\nSELECT c.customerkey customer_id\n       ,c.firstname customer_first_name\n       ,c.lastname customer_last_name\n       ,c.phone Phone\n       ,d.CalendarYear year\n       ,sum(isnull(s.UnitPrice-s.TotalProductCost-s.UnitPriceDiscountPct, 0)/2) year_total\n       ,'s' sale_type\nFROM Sample.dimCustomer c\n     ,Sample.factinternetsales s\n     ,Sample.dimdate d\nWHERE c.customerkey = s.customerkey\n   AND s.orderdatekey = d.datekey\nGROUP BY c.customerkey\n         ,c.firstname\n         ,c.lastname\n         ,c.phone\n         ,d.calendaryear\n)\n SELECT\n     Customer_id\n    ,Customer_First_Name\n    ,Customer_Last_Name\n    ,avg(year_total) Avg_Year_Total\n    ,min(year_total) Min_Total\n    ,max(year_total) Max_Total\nFROM year_total \n  GROUP BY customer_id\n          ,customer_first_name\n          ,customer_last_name;\n      \n-- Use Explain With_Recommendations to get recommendations for Materialized view.\nEXPLAIN WITH_RECOMMENDATIONS\nWITH year_total AS (\nSELECT c.customerkey customer_id\n       ,c.firstname customer_first_name\n       ,c.lastname customer_last_name\n       ,c.phone Phone\n       ,d.CalendarYear year\n       ,sum(isnull(s.UnitPrice-s.TotalProductCost-s.UnitPriceDiscountPct, 0)/2) year_total\n       ,'s' sale_type\nFROM Sample.dimCustomer c\n     ,Sample.factinternetsales s\n     ,Sample.dimdate d\nWHERE c.customerkey = s.customerkey\n   AND s.orderdatekey = d.datekey\nGROUP BY c.customerkey\n         ,c.firstname\n         ,c.lastname\n         ,c.phone\n         ,d.calendaryear\n)\n SELECT\n       Customer_id\n      ,Customer_First_Name\n      ,Customer_Last_Name\n      ,avg(year_total) Avg_Year_Total\n      ,min(year_total) Min_Total\n      ,max(year_total) Max_Total\nFROM year_total \n  GROUP BY customer_id\n         ,customer_first_name\n         ,customer_last_name;\n      \n\n-- Create materialized view based on the recommendation provided\nCREATE MATERIALIZED VIEW Sample.MVExample WITH (DISTRIBUTION = HASH([Customer_ID])) AS\nSELECT [c].[CustomerKey] AS Customer_ID,\n       [c].[FirstName] AS Customer_First_Name,\n       [c].[LastName] AS Customer_Last_Name,\n       [c].[Phone] AS Phone,\n       [d].[CalendarYear] AS CalendarYear,\n       SUM(isnull(CONVERT(float(53),[s].[UnitPrice]-[s].[TotalProductCost],0)-[s].[UnitPriceDiscountPct],(0.0000000000000000e+000))/(2.0000000000000000e+000)) AS Year_Total\nFROM [Sample].[DimCustomer] [c],\n     [Sample].[FactInternetSales] [s],\n     [Sample].[DimDate] [d]\nWHERE ([s].[OrderDateKey]=[d].[DateKey])\n  AND ([c].[CustomerKey]=[s].[CustomerKey])\nGROUP BY [c].[CustomerKey],\n         [c].[FirstName],\n         [c].[LastName],\n         [c].[Phone],\n         [d].[CalendarYear];\n\n-- Clear cache\nDBCC DROPRESULTSETCACHE; \n\n-- Run a query referencing the materialized view\nSELECT\n                  Customer_id\n                 ,Customer_First_Name\n                 ,Customer_Last_Name\n                 ,avg(year_total) Avg_Year_Total\n                 ,min(year_total) Min_Total\n                 ,max(year_total) Max_Total\nFROM  Sample.MVExample\n  GROUP BY customer_id\n         ,customer_first_name\n         ,customer_last_name;\n\n-- Clear cache\nDBCC DROPRESULTSETCACHE; \n\n-- Run a query covered by the materialized view\nSELECT [c].[CustomerKey] AS Customer_ID,\n       [d].[CalendarYear] AS CalendarYear,\n       SUM(isnull(CONVERT(float(53),[s].[UnitPrice]-[s].[TotalProductCost],0)-[s].[UnitPriceDiscountPct],(0.0000000000000000e+000))/(2.0000000000000000e+000)) AS Year_Total\nFROM [Sample].[DimCustomer] [c],\n     [Sample].[FactInternetSales] [s],\n     [Sample].[DimDate] [d]\nWHERE ([s].[OrderDateKey]=[d].[DateKey])\n  AND ([c].[CustomerKey]=[s].[CustomerKey])\nGROUP BY [c].[CustomerKey],\n         [d].[CalendarYear];\n\n\n/*\nCLEAN UP:\nDROP VIEW Sample.MVExample;\n*/",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "DataWarehouse",
				"poolName": "DataWarehouse"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}